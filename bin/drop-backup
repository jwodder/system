#!/bin/bash
# Usage: sudo ./drop-backup [--rsync-only]
ROOT=/var/backups/jwodder
: "${VENV_PATH:=/var/lib/jwodder/dropbox}"

if ((EUID != 0))
then echo "$0: This script must be run as root."
     exit 1
fi

set -ex
mkdir -p "$ROOT"

for dir in /root /home /var/mail /var/mail.old /var/www /etc/letsencrypt \
           /opt/jwodder /opt/jwodder-postfix
do if [ -e "$dir" ]
   then if [ "$dir" = /var/www ]
        then links=
        else links=--copy-unsafe-links
        fi
        rsync -avR $links --delete --delete-excluded \
              --exclude-from=/opt/jwodder/etc/backup.exclude \
              --exclude-from=<(find "$dir" -type d -exec test -e {}/.norsync ';' -print) \
              "$dir" "$ROOT"
   else rm -rf "$ROOT$dir"
   fi
done

if [ -x /etc/init.d/postgresql ]
### TODO: Look for a better way to test whether PostgreSQL is installed.
then sudo -u postgres pg_dumpall > "$ROOT/postgres.sql"
# Don't use `-f` here, as postgres can't write to $ROOT.
else rm -rf "$ROOT/postgres.sql"
fi

[ "$1" != "--rsync-only" ] || exit 0

cd "$ROOT"
TARBALL=/var/backups/`hostname`-`date -u +%Y%m%dT%H%M%SZ`.tgz
tar zcf "$TARBALL" .

$VENV_PATH/bin/python /opt/jwodder/bin/dropboxadd "$TARBALL" \
                                                  /Historical/Backups/Droplets/

rm -f "$TARBALL"
