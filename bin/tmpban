#!/usr/bin/python
import argparse
import json
import subprocess
import sys
from   psycopg2 import connect

credsfile = '/opt/jwodder/etc/tmpban.json'

parser = argparse.ArgumentParser()
parser.add_argument('-d', '--days', type=int, default=30)
parser.add_argument('-n', '--dry-run', action='store_true')
parser.add_argument('-q', '--quiet', action='store_true')
parser.add_argument('-r', '--reason')
parser.add_argument('ip_addr', nargs='*')
args = parser.parse_args()

if args.days < 1:
    raise SystemExit('%s: --days must be at least 1' % (sys.argv[0],))

with open(credsfile) as fp:
    creds = json.load(fp)
db = connect(**creds)
cursor = db.cursor()

for ip_addr in args.ip_addr:
    cursor.execute('SELECT 1 FROM bans WHERE ip_addr = %s', (ip_addr,))
    if cursor.fetchone() is None:
        if not args.dry_run:
            cursor.execute('''
                INSERT INTO bans (ip_addr, ban_start, ban_end, reason)
                VALUES (%s, now(), now() + interval %s DAY, %s)
            ''', (ip_addr, str(args.days), args.reason))
            subprocess.check_output(['sudo', 'ufw', 'insert', '1', 'deny', 'in',
                                     'from', ip_addr])
            db.commit()
        print ip_addr
    elif not args.quiet:
        sys.stderr.write(ip_addr + ': already banned\n')
