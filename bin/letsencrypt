#!/bin/bash
# Note that, as of 2016-01-09, wildcard certs are still not supported.
((EUID == 0)) || exec sudo "$0" "$@"

VENV_PATH="${1:-/usr/local/virtualenvs/letsencrypt}"

function installed {
    test "$(dpkg-query -Wf '${db:Status-Abbrev}' "$1" 2>/dev/null)" = "ii "
}

set -ex
DOMAINS="$(paste -d, -s ${1:-/opt/jwodder/etc/domains})"

if installed apache2
then service apache2 stop
else ufw allow in 80
     ufw allow in 443
fi

$VENV_PATH/bin/letsencrypt certonly \
    --standalone \
    --rsa-key-size 4096 \
    --renew-by-default \
    --server https://acme-v01.api.letsencrypt.org/directory \
    --email jwodder+letsencrypt@gmail.com \
    --domains "$DOMAINS"

if installed apache2
then service apache2 start
else ufw delete allow in 80
     ufw delete allow in 443
fi

if installed postfix
then service postfix stop
     service postfix start
fi
