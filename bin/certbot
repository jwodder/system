#!/bin/bash

# cf. <https://github.com/blacklabelops/letsencrypt>
# cf. <https://github.com/janeczku/rancher-letsencrypt>

# For first acquiring certs for domains (including adding a domain to the set
# of cert'ed domains)

# Idempotent?

# Note that, as of 2016-01-09, wildcard certs are still not supported.
((EUID == 0)) || exec sudo "$0" "$@"

set -ex
DOMAINS="$(paste -d, -s /opt/jwodder/etc/localhost/certbot_domains)"
EMAIL="$(< /opt/jwodder/etc/localhost/certbot_email)"

. /opt/jwodder/lib/certbot-common

$VENV_PATH/bin/certbot certonly \
    --standalone \
    --rsa-key-size 4096 \
    --expand \
    --email "$EMAIL" \
    --domains "$DOMAINS" \
    --non-interactive \
    --pre-hook "$pre_hook" \
    --post-hook "$post_hook" \
    --agree-tos

    #--force-renewal \
